<!DOCTYPE html>
<html>
<head>
  <title>OD parser</title>
  <meta name="description" content="Lisa's friend and helper.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
  <div class="cont" style="text-align: center; margin-top: 200px">
    <div class="dec">
      <img id="ls" src="" alt="">
    </div>
    <input type="file" onChange="readmultifiles" multiple="multiple"/>
  </div>
  <script>
  var ims = ["lisa1.png","lisa2.png","lisa3.png","lisa4.png","lisa5.png"];
  var im = ims[Math.floor(Math.random() * ims.length)];
  document.getElementById('ls').src = im;

  var input = document.querySelector('input');
  input.addEventListener('change', readmultifiles);

  function download(data, filename, type) {
    var file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
    window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
      var a = document.createElement("a"),
      url = URL.createObjectURL(file);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function() {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 0);
    }
  }

  var lcfmt = d3.formatLocale({
    "decimal": ",",
    "thousands": ""
  });
  var nbfmt = lcfmt.format(".6f");

  function readmultifiles() {
    csv = "File;Date;Time;Assay;Cell line;Passage;Incubation [h];Substance;"+
          "Concentration [µM];OD1;OD2;OD.var;OD;Control;Ratio [%]\n";
    const files = this.files;
    Object.keys(files).forEach(i => {
      const file = files[i];
      const reader = new FileReader();
      reader.onload = (e) => {
        var data = d3.tsvParseRows(reader.result);
        var fn = data[1][1];
        console.log(fn);
        var date = data[3][1];
        var time = data[3][2];
        var fns = fn.split(",");
        var assay = fns[0].split(" ")[0];
        var incubation = fns[0].split(" ")[1];
        var cellline = fns[1];
        var passage = fns[2].split("p")[1];
        data = data.slice(16,24);
        var cvals = data[6].slice(1,10).concat(data[7].slice(1,10));
        var control = d3.mean(cvals);
        csv += fn+";"+date+";"+time+";"+assay+";"+cellline+";"+passage+";"+
               incubation+";"+"Medium"+";"+""+";"+nbfmt(d3.min(cvals))+";"+
               nbfmt(d3.max(cvals))+";"+nbfmt(d3.variance(cvals))+";"+
               nbfmt(control)+";"+nbfmt(control)+";"+
               nbfmt(control*100/control)+"\n";
        var dvals = d3.transpose(data)[10].slice(0,4);
        var dmso = d3.mean(dvals);
        csv += fn+";"+date+";"+time+";"+assay+";"+cellline+";"+passage+";"+
               incubation+";"+"DMSO"+";"+""+";"+nbfmt(d3.min(dvals))+";"+
               nbfmt(d3.max(dvals))+";"+nbfmt(d3.variance(dvals))+";"+
               nbfmt(dmso)+";"+nbfmt(control)+";"+nbfmt(dmso*100/control)+"\n";
        var rns = ["Betulinsäure","Disulfamat","Tris-Ester"];
        var cns = ["","1","2.5","5","10","20","40","60","80","100"];
        for (var j = 0; j < 3; j++) {
          r = j*2;
          for (var k = 1; k < 10; k++) {
            var val1 =data[r].slice(k,k+1);
            var val2 =data[r+1].slice(k,k+1);
            var val = d3.mean(val1.concat(val2));
            var valv = d3.variance(val1.concat(val2));
            csv += fn+";"+date+";"+time+";"+assay+";"+cellline+";"+passage+";"+
                   incubation+";"+rns[j]+";"+nbfmt(cns[k])+";"+nbfmt(val1)+";"+
                   nbfmt(val2)+";"+nbfmt(valv)+";"+nbfmt(val)+";"+
                   nbfmt(control)+";"+nbfmt(val*100/control)+"\n";
          };
        };
        if (file == files[files.length-1]) {
          download(csv, "data.csv", "text/csv");
        }
      }
      reader.readAsBinaryString(file);
    })
  };
</script>
</body>
</html>
