<!DOCTYPE html>
<html>
<head>
  <title>OD parser</title>
  <meta name="description" content="Lisa's friend and helper.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
  <!-- <div class="label" style="text-align: center; font-family:sans">MTS mode</div> -->
  <div class="cont" style="text-align: center; margin-top: 200px">
    <div class="dec">
      <img src="lisa.png" alt="">
    </div>
    <input type="file" onChange="readmultifiles" multiple="multiple"/>
  </div>
<script>
var input = document.querySelector('input');
input.addEventListener('change', readmultifiles);

function download(data, filename, type) {
  var file = new Blob([data], {type: type});
  if (window.navigator.msSaveOrOpenBlob) // IE10+
  window.navigator.msSaveOrOpenBlob(file, filename);
  else { // Others
    var a = document.createElement("a"),
    url = URL.createObjectURL(file);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(function() {
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }, 0);
  }
}

var lcfmt = d3.formatLocale({
      "decimal": ",",
      "thousands": ""
    });
var nbfmt = lcfmt.format(".6f");

function readmultifiles() {
  csv = "File;Date;Time;Assay;Cell line;Passage;Incubation;Substance;Concentration [µM];OD;Control;Ratio [%]\n";
  const files = this.files;
  Object.keys(files).forEach(i => {
    const file = files[i];
    const reader = new FileReader();
    reader.onload = (e) => {
      var data = d3.tsvParseRows(reader.result);
      var fn = data[1][1];
      console.log(fn);
      var date = data[3][1];
      var time = data[3][2];
      var fns = fn.split(",");
      var assay = fns[0].split(" ")[0];
      var incubation = fns[0].split(" ")[1];
      var cellline = fns[1];
      var passage = fns[2].split("p")[1];
      data = data.slice(16,24);
      var control = d3.mean(data[6].slice(1,10).concat(data[7].slice(1,10)));
      csv += fn+";"+date+";"+time+";"+assay+";"+cellline+";"+passage+";"+incubation+";"+"Medium"+";"+""+";"+nbfmt(control)+";"+nbfmt(control)+";"+nbfmt(control*100/control)+"\n";
      var dmso = d3.mean(d3.transpose(data)[10].slice(0,4));
      csv += fn+";"+date+";"+time+";"+assay+";"+cellline+";"+passage+";"+incubation+";"+"DMSO"+";"+""+";"+nbfmt(dmso)+";"+nbfmt(control)+";"+nbfmt(dmso*100/control)+"\n";
      var rns = ["Betulinsäure","Disulfamat","Tris-Ester"];
      var cns = ["","1","2.5","5","10","20","40","60","80","100"];
      for (var j = 0; j < 3; j++) {
        r = j*2;
        for (var k = 1; k < 10; k++) {
          var val = d3.mean(data[r].slice(k,k+1).concat(data[r+1].slice(k,k+1)));
          csv += fn+";"+date+";"+time+";"+assay+";"+cellline+";"+passage+";"+incubation+";"+rns[j]+";"+nbfmt(cns[k])+";"+nbfmt(val)+";"+nbfmt(control)+";"+nbfmt(val*100/control)+"\n";
        };
      };
      if (file == files[files.length-1]) download(csv, "data.csv", "text/csv");
    }
    reader.readAsBinaryString(file);
  })
};
</script>
</body>
</html>
